<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Decode Hidden Message</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ‚úÖ CryptoJS for AES + SHA256 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <style>
    body { background:#f8f9fa; }
    .container { max-width: 900px; margin-top: 2rem; }
    #canvasbox canvas {
      max-width: 100%;
      border:1px solid #dee2e6;
      border-radius:.375rem;
      margin-top:1rem;
    }
  </style>
</head>
<body>
<div class="container">

  <h2 class="text-center mb-4">üîç Decode Hidden Message From PNG</h2>

  <!-- Upload -->
  <div class="card mb-3">
    <div class="card-body">

      <label class="form-label">1. Upload Encoded PNG</label>
      <input type="file" class="form-control" id="decodeImageInput" accept="image/png">

      <label class="form-label mt-3">2. Enter Password</label>
      <input type="text" class="form-control" id="passwordInput" placeholder="Password (default: ISAA)">
    </div>
  </div>

  <!-- Canvas preview -->
  <div class="card mb-3">
    <div class="card-body text-center" id="canvasbox">
      <p class="text-muted m-0">Image preview will appear here</p>
    </div>
  </div>

  <div class="d-grid mb-4">
    <button id="decodeBtn" class="btn btn-primary btn-lg">Decode Message</button>
  </div>

  <div class="card">
    <div class="card-body">
      <label class="form-label">Decoded Message:</label>
      <textarea class="form-control" id="secretText" rows="7" readonly></textarea>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const decodeBtn        = document.getElementById("decodeBtn");
  const decodeImageInput = document.getElementById("decodeImageInput");
  const passwordInput    = document.getElementById("passwordInput");
  const canvasBox        = document.getElementById("canvasbox");
  const secretText       = document.getElementById("secretText");

  let canvas, ctx, originalImage;

  // Create canvas
  function getCanvas() {
    if (!canvas) {
      canvas = document.createElement("canvas");
      canvasBox.innerHTML = "";
      canvasBox.appendChild(canvas);
      ctx = canvas.getContext("2d", { willReadFrequently: true });
    }
    return { canvas, ctx };
  }

  // Load image into canvas
  decodeImageInput.addEventListener("change", () => {
    const file = decodeImageInput.files[0];
    if (!file) return alert("Select a PNG image first.");

    const reader = new FileReader();
    reader.onload = e => {
      originalImage = new Image();
      originalImage.onload = () => {
        const { canvas, ctx } = getCanvas();
        canvas.width = originalImage.width;
        canvas.height = originalImage.height;
        ctx.drawImage(originalImage, 0, 0);
      };
      originalImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  // ----------- RAW AES DECRYPT HELPERS -------------

  function u8ToWordArray(u8) {
    let words = [];
    for (let i = 0; i < u8.length; i += 4) {
      words.push(
        ((u8[i] || 0) << 24) |
        ((u8[i + 1] || 0) << 16) |
        ((u8[i + 2] || 0) << 8) |
        (u8[i + 3] || 0)
      );
    }
    return CryptoJS.lib.WordArray.create(words, u8.length);
  }

  function decryptAES_RawBytes(rawBytes, passphrase) {
    const iv = rawBytes.slice(0, 16);
    const cipherBytes = rawBytes.slice(16);

    const key = CryptoJS.SHA256(passphrase);

    const decrypted = CryptoJS.AES.decrypt(
      { ciphertext: u8ToWordArray(cipherBytes) },
      key,
      {
        iv: u8ToWordArray(iv),
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
      }
    );

    const text = decrypted.toString(CryptoJS.enc.Utf8);
    return text || null;
  }

  // ----------- MAIN DECODING LOGIC -------------

  decodeBtn.addEventListener("click", () => {

    if (!originalImage) return alert("Upload PNG first.");
    const passphrase = passwordInput.value.trim() || "ISAA";

    const { canvas, ctx } = getCanvas();
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = img.data;

    // Extract all LSB bits (skip alpha channel)
    let bits = [];
    for (let i = 0; i < data.length; i++) {
      if (i % 4 === 3) continue;  // skip alpha channel
      bits.push(data[i] & 1);
    }

    // First 32 bits = message length
    let msgLen = 0;
    for (let i = 0; i < 32; i++) {
      msgLen = (msgLen << 1) | bits[i];
    }

    // Extract raw encrypted bytes
    let rawBytes = new Uint8Array(msgLen);
    let bitPtr = 32;

    for (let byteIndex = 0; byteIndex < msgLen; byteIndex++) {
      let byte = 0;
      for (let b = 0; b < 8; b++) {
        byte = (byte << 1) | bits[bitPtr++];
      }
      rawBytes[byteIndex] = byte;
    }

    // AES decrypt (raw bytes)
    const decrypted = decryptAES_RawBytes(rawBytes, passphrase);

    if (!decrypted) {
      alert("‚ùå Wrong password or corrupted image.");
      return;
    }

    secretText.value = decrypted;
  });

});
</script>

</body>
</html>
